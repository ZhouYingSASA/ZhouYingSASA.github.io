<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Redis 简介"><meta name="keywords" content="原创,数据结构,并发,数据库"><meta name="author" content="ZhouYingSASA"><meta name="copyright" content="ZhouYingSASA"><title>Redis 简介 | 咒影的个人博客</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.2.0'
} </script><meta name="generator" content="Hexo 5.2.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.</span> <span class="toc-text"> 线程模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text"> 数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2-simple-dynamic-string"><span class="toc-number">2.1.</span> <span class="toc-text"> 简单动态字符串 Simple Dynamic String</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E5%85%B8"><span class="toc-number">2.2.</span> <span class="toc-text"> 字典</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">2.2.0.1.</span> <span class="toc-text"> 简介</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#rehash"><span class="toc-number">2.2.0.2.</span> <span class="toc-text"> Rehash</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F"><span class="toc-number">3.</span> <span class="toc-text"> 分布式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8Eslaveof-master_ip-master_port"><span class="toc-number">3.1.</span> <span class="toc-text"> 主从：SLAVEOF &lt;master_ip&gt; &lt;master_port&gt;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4-cluster-meet-ip-port"><span class="toc-number">3.2.</span> <span class="toc-text"> 集群： CLUSTER MEET &lt;ip&gt; &lt;port&gt;</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text"> 高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-rdb-%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">4.1.</span> <span class="toc-text"> 1. RDB 持久化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-aof-%E6%8C%81%E4%B9%85%E5%8C%96-append-only-file"><span class="toc-number">4.2.</span> <span class="toc-text"> 2. AOF 持久化 (Append Only File)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%93%A8%E5%85%B5-sentinel-redis-sentinel-pathtoyoursentinelconf"><span class="toc-number">4.3.</span> <span class="toc-text"> 3. 哨兵 Sentinel： $ redis-sentinel &#x2F;path&#x2F;to&#x2F;your&#x2F;sentinel.conf</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">ZhouYingSASA</div><div class="author-info__description text-center">Do what you love, Love what you do</div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/ZhouYingSASA">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">14</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">14</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友链</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://blog.lenconda.top">Lenconda 的技术博客</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://blog.lxxyx.cn">繁易の前端乐园</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://blog.exql.net">Exqlnet 的网络博客</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://blog.vadxq.com">清竹茶馆</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://blog.jinof.now.sh">Jinof 的博客</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://home.guoxy.top/">Guoxy's Home</a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">咒影的个人博客</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">Redis 简介</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-03-16</time><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">2.2k</span><span class="post-meta__separator">|</span><span>Reading time: 6 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>Redis 是一个用 C 实现的开源、支持网络、基于内存、分布式、可选持久性的键值对存储数据库。</p>
<a id="more"></a>
<p><a name="E0CSj"></a></p>
<h2 id="线程模型"><a class="markdownIt-Anchor" href="#线程模型"></a> 线程模型</h2>
<p>Redis 内部使用<strong>文件事件处理器 file event handler</strong>，它是单线程的，所以 Redis 是单线程模型。它采用<strong>IO多路复用机制</strong>同时监听多个 socket，将产生事件的 socket 压入内存队列中，事件分派器根据 socket 上的事件类型来选择对应的事件处理器进行处理。</p>
<p><img src="/img/2136379-20200830233359116-1537526582.png" alt="图片来自 MrMirror" /></p>
<p><a name="#MavNn"></a></p>
<h2 id="数据结构"><a class="markdownIt-Anchor" href="#数据结构"></a> 数据结构</h2>
<p><a name="WfFOT"></a></p>
<h3 id="简单动态字符串-simple-dynamic-string"><a class="markdownIt-Anchor" href="#简单动态字符串-simple-dynamic-string"></a> 简单动态字符串 Simple Dynamic String</h3>
<p>Redis 没有使用 C 中传统的字符串表示，而是自己创建了这样一个类型作为自己的默认字符串格式。Redis 只会在无需更改字符串内容的地方使用 C 的字符串。</p>
<p>SDS 是由头部 sdshdr（struct）和存储区 buf（char []）两部分组成。在 sdshdr 中记录了<strong>未使用长度 free</strong>（int），<strong>总长度 len</strong> （int），以及存储区的指针 buf。而存储区保存了 C 的惯例，以 ‘\0’ 作为字符串的结尾。</p>
<p>SDS因为存储了 free 和 len，并且使用字节数组存储内容，所以可以以 O(1) 获取字符串的长度，而不像 C 那样需要遍历它。并且因为存储了总长 len，所以写入更新时不会超出分配的空间而造成缓冲区溢出。写入时 Redis 会快速检查 free 和 len，当剩余空间<strong>不足时会扩容一倍</strong>再进行修改（最大扩容1MB）；而删除更新时（注意不是删除整个值），因为记录了 free，不会在每次删除更新时重分配内存，而实现了<strong>懒释放</strong>。这种机制对于需要面对频繁更改的业务场景的 redis 来说能节省不少性能开销。</p>
<p>当然 Redis 也提供了相应的 API 让我们在需要时真正释放 free 空间，而不用担心造成内存的浪费。</p>
<p><a name="fPQqV"></a></p>
<h3 id="字典"><a class="markdownIt-Anchor" href="#字典"></a> 字典</h3>
<p><a name="3udlB"></a></p>
<h5 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h5>
<p>Redis 的字典依然分为两部分，由一个头部 dict 和一个 Hashtable 组成。不同的是 Redis 为它的 Hashtable 也设计了一个头部 dictht ( Dict HashTable )。</p>
<p>dict 头部保存了类型函数指针 type 和私有数据，并且保存有 Rehash Index ( rehashidx ) 和指向两张哈希表表头的指针 (ht) 。当添加键值时，调用类型函数指针中的哈希函数计算出它应该放在哪个位置。dictht 保存有哈希表的数组头指针 table、数组大小 size、数组掩码 sizemask ( =size-1 ) 和已使用数量 used。当不在进行 rehash 的时候，dict-&gt;rehashidx 为-1，而第二张哈希表处于空闲状态，仅存在表头 ht[1]，而其中的 table 指针为空。</p>
<p><a name="YMCvW"></a></p>
<h5 id="rehash"><a class="markdownIt-Anchor" href="#rehash"></a> Rehash</h5>
<p>当哈希表 used/size &gt;= 1 则表明该字典需要进行 rehash ( 特别地，如果在进行后台持久化时，该值会被设定为 5 ) 。Rehash 采用分治法将全部的计算量分摊到每一次对其的增删查改上。首先将 rehashidx 设为 0 代表每次操作需要附加 rehash 操作。而每次的增删查改会顺带将第一张表 <code>ht[0][rehashidx]</code> 上的内容 Rehash 到第二张表 <code>ht[1][dict-&gt;type-&gt;hashFunction(key) &amp; dict-&gt;ht[1]-&gt;sizemask]</code> 上，并将 rehashidx+1。<br />
当 rehash 完成后，第一张表的空间将被释放，而第二张表头的 table 指针会被赋值给第一张表。</p>
<p><a name="QvIxg"></a></p>
<h2 id="分布式"><a class="markdownIt-Anchor" href="#分布式"></a> 分布式</h2>
<p><a name="twdhH"></a></p>
<h3 id="主从slaveof-master_ip-master_port"><a class="markdownIt-Anchor" href="#主从slaveof-master_ip-master_port"></a> 主从：<code>SLAVEOF &lt;master_ip&gt; &lt;master_port&gt;</code></h3>
<p>当从服务器（以下简称从）接收到 slaveof 命令后，首先保存这两个值，并返回OK，在这之后，从才会开始复制工作。也可以在从的 <code>redis.conf</code> 中设置这条命令。</p>
<p>首先从会根据相关属性建立与主服务器（以下简称主）的连接，如果建立成功则创建一个处理器用于处理复制工作。整个工作是通过“从向主发送命令”来进行。当从成为主的客户端后，首先发送一个 Ping 命令检查 Socket 连接是否正常，以及主能否正常处理命令。如果 ping 出现异常则会断开并重新建立连接。</p>
<p>此后根据配置文件中的 masterauth 决定是否发送 <code>AUTH &lt;password&gt;</code>  命令。当主的 <code>requirepass</code> 和从的 <code>masterauth</code> 字段相同或都不存在时才会通过身份验证，否则都会返回错误使中止复制。</p>
<p>身份验证之后，从向主发送自己的监听端口，方便主在有数据更改时通知从。在此之后，主也成为了从的客户端，然后就会开始同步。同步分为全量和增量。其中全量复制是通过从发送 SYNC 命令，然后主发送 <a href="#PiviR">RDB 文件</a> 和缓冲区的写命令完成的，而从执行 RDB 载入的时候是阻塞的，无法响应外界命令。</p>
<p>而如果仅是网络中断导致的重新复制，则会启动增量更新。在同步过程中主从各自维护一个复制偏移量 offset，增量更新时会从较少的 offset 开始传递数据。传递数据前，从将自己维护的 offset 发送给主，如果 offset 超出了主的缓冲区，或者传递数据时主的 runid 与从所保存的不一致，就会启动全量更新。</p>
<p>而其余部分与其他主从系统相似，包括心跳机制、最小从数、最小时延。</p>
<p>当主服务器宕机后，需要人工更换主服务器，所以缺乏高可用性。Redis 提供了主从复制的高可用解决方案 <a href="#3lwP9">哨兵 Sentinel</a>。它们之间互相连接并共同监视所有服务器的健康状态。</p>
<p><a name="tG06E"></a></p>
<h3 id="集群-cluster-meet-ip-port"><a class="markdownIt-Anchor" href="#集群-cluster-meet-ip-port"></a> 集群： <code>CLUSTER MEET &lt;ip&gt; &lt;port&gt;</code></h3>
<p>集群是 Redis 提供的分布式数据库解决方案，通过分片 ( Sharding ) 来进行数据共享，并提供复制和故障转移功能。每当集群内有节点进行 Meet 握手或是主从复制、故障转移时都会通过 Gossip 协议通告全集群。</p>
<p>一个集群被分片为若干个槽，需要所有槽都有节点负责才能使集群上线。每个节点会维护一个状态列表，存放公共信息 ( 比如槽的归属 ) 。每当有命令通过一个节点进入集群时，该节点负责计算这个命令归属于哪一个槽，如果属于自己负责的那就立刻处理，否则返回重定向至对应节点处理。</p>
<p>当一个主下线时，对应的槽由其从服务器之一接管，并成为主。下线的服务器恢复之后，会成为它的从。</p>
<p><a target="_blank" rel="noopener" href="https://www.google.com/search?&amp;q=Gossip+%E5%8D%8F%E8%AE%AE">Gossip 协议</a>可能是最有趣的一致性协议。它基于六度分隔理论生动形象地说明了八(bìng)卦(dú)传(gǎn)播(rǎn)的迅速。</p>
<p><a name="i632x"></a></p>
<h2 id="高可用"><a class="markdownIt-Anchor" href="#高可用"></a> 高可用</h2>
<p><a name="PiviR"></a></p>
<h3 id="1-rdb-持久化"><a class="markdownIt-Anchor" href="#1-rdb-持久化"></a> 1. RDB 持久化</h3>
<p>RDB 持久化可以手动执行，也可以根据配置定期执行。有两个命令可以用于生成 RDB 文件，分别是 <code>SAVE</code> 和 <code>BGSAVE</code> 。 <code>SAVE</code> 会阻塞 Redis 进程直至 RDB 文件创建完毕，而 <code>BGSAVE</code> 会 fork 出一个子进程负责创建 RDB。</p>
<p>为了避免父进程与子进程同时执行 <code>rdbSave</code> 调用而产生竞争，<code>SAVE</code> 和 <code>BGSAVE</code> 是禁止同时执行的。</p>
<p><a name="J4Bkx"></a></p>
<h3 id="2-aof-持久化-append-only-file"><a class="markdownIt-Anchor" href="#2-aof-持久化-append-only-file"></a> 2. AOF 持久化 (Append Only File)</h3>
<p>AOF 持久化是通过保存 Redis 所执行的写命令来记录数据库状态的，分为命令追加 ( append )、文件写入、文件同步 ( sync ) 三个步骤。当 AOF 处于开启状态时，服务器执行完一个命令后，会以协议格式（文本）写入 aof_buf 缓冲区，并在一次事件循环后根据配置选择是否要求操作系统立刻与磁盘上的 AOF 文件同步。该同步会开启一个新线程负责执行。</p>
<p><a name="3lwP9"></a></p>
<h3 id="3-哨兵-sentinel-redis-sentinel-pathtoyoursentinelconf"><a class="markdownIt-Anchor" href="#3-哨兵-sentinel-redis-sentinel-pathtoyoursentinelconf"></a> 3. 哨兵 Sentinel： <code>$ redis-sentinel /path/to/your/sentinel.conf</code></h3>
<p>哨兵是分布式 Redis 故障转移机制中用于监视其他 Redis 的 Redis。Redis 的哨兵可以有多个，并且互相连接。<br />
当一个哨兵被启动时：</p>
<ol>
<li>初始化一个正常的 Redis 并将这个 Redis 的代码替换为哨兵专用代码。</li>
<li>初始化哨兵并创建与所有服务器的命令连接和订阅连接，获取其信息。</li>
</ol>
<p>哨兵通过心跳检测某个服务器是否主观下线。如果主被检测为主观下线，就会询问其他哨兵，其他哨兵会回复他视角下的主的状态，主的id和当前纪元。达到足够数量后，哨兵们内部选举出一个哨兵主持下一纪元的主服务器选举。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">ZhouYingSASA</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://zhouyingsasa.xyz/2021/03/16/Redis/">http://zhouyingsasa.xyz/2021/03/16/Redis/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%8E%9F%E5%88%9B/">原创</a><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a><a class="post-meta__tags" href="/tags/%E5%B9%B6%E5%8F%91/">并发</a><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></div><nav id="pagination"><div class="next-post pull-right"><a href="/2020/12/21/%E7%B2%98%E5%AF%B9/"><span>粘对</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2021 By ZhouYingSASA</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="icp"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/"><span>闽ICP备19005195号</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css"><script src="/js/katex.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>